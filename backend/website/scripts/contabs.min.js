var tabs = ['home'];

function removeTab(id) {
    for (var i = 0; i < tabs.length; i++) {
        if (tabs[i] == id) {
            tabs.splice(i, 1);
            break;
        }
    }
}

function addTab(id) {
    removeTab(id);
    tabs.push(id);
}

function getCurrentTabId() {
    if (tabs.length) {
        return tabs[tabs.length - 1];
    }
}

function getTab(id) {
    if (!id) {
        return null;
    }

    var tab = null;
    $(".J_menuTab").each(function () {
        if ($(this).data("id") == id) {
            tab = this;
            return false;
        }
    });
    return tab;
}

function getCurrentTab() {
    var tabId = getCurrentTabId();
    if (!tabId) {
        return null;
    }
    return getTab(tabId);
}

function getTabContent(id) {
    if (!id) {
        return null;
    }

    var window = null;
    $(".J_mainContent .J_iframe").each(function () {
        if ($(this).data("id") == id) {
            window = this;
            return false;
        }
    });
    return window;
}

function getCurrentTabContent() {
    var tabId = getCurrentTabId();
    if (!tabId) {
        return null;
    }
    return getTabContent(tabId);
}

function openTab(href, title) {
    $("#openTab").attr("href", href).text(title).triggerHandler('click', [true]);
}
function reloadTab(tab, href, title) {
    if (href == undefined || $.trim(href).length == 0) {
        return false
    }
    var id = href;
    if (id.indexOf('?') > -1) {
        id = id.substr(0, id.indexOf('?'));
    }

    if (tab && tab.contentWindow) {
        if (title) {
            $(".J_menuTab.active").html(title + '<i class="fa fa-times-circle"></i>').data("id", id);
        }

        $(tab).data("id", id);
        $(".J_menuTab.active").data("id", id);
        tab.contentWindow.location.href = href;
    }
}
function reloadCurrentTab(href, title) {
    var tab = getCurrentTabContent();
    reloadTab(tab, href, title);
}
function refreshTab(tab) {
    if (tab && tab.contentWindow && tab.contentWindow.ajaxRefresh) {
        tab.contentWindow.ajaxRefresh();
    }
}
function refreshCurrentTab() {
    var tab = getCurrentTabContent();
    refreshTab(tab);
}
$(function () {
    function f(l) {
        var k = 0;
        $(l).each(function () {
            k += $(this).outerWidth(true)
        });
        return k
    }

    function g(n) {
        var o = f($(n).prevAll()), q = f($(n).nextAll());
        var l = f($(".content-tabs").children().not(".J_menuTabs"));
        var k = $(".content-tabs").outerWidth(true) - l;
        var p = 0;
        if ($(".page-tabs-content").outerWidth() < k) {
            p = 0
        } else {
            if (q <= (k - $(n).outerWidth(true) - $(n).next().outerWidth(true))) {
                if ((k - $(n).next().outerWidth(true)) > q) {
                    p = o;
                    var m = n;
                    while ((p - $(m).outerWidth()) > ($(".page-tabs-content").outerWidth() - k)) {
                        p -= $(m).prev().outerWidth();
                        m = $(m).prev()
                    }
                }
            } else {
                if (o > (k - $(n).outerWidth(true) - $(n).prev().outerWidth(true))) {
                    p = o - $(n).prev().outerWidth(true)
                }
            }
        }
        $(".page-tabs-content").animate({marginLeft: 0 - p + "px"}, "fast")
    }

    function a() {
        var o = Math.abs(parseInt($(".page-tabs-content").css("margin-left")));
        var l = f($(".content-tabs").children().not(".J_menuTabs"));
        var k = $(".content-tabs").outerWidth(true) - l;
        var p = 0;
        if ($(".page-tabs-content").width() < k) {
            return false
        } else {
            var m = $(".J_menuTab:first");
            var n = 0;
            while ((n + $(m).outerWidth(true)) <= o) {
                n += $(m).outerWidth(true);
                m = $(m).next()
            }
            n = 0;
            if (f($(m).prevAll()) > k) {
                while ((n + $(m).outerWidth(true)) < (k) && m.length > 0) {
                    n += $(m).outerWidth(true);
                    m = $(m).prev()
                }
                p = f($(m).prevAll())
            }
        }
        $(".page-tabs-content").animate({marginLeft: 0 - p + "px"}, "fast")
    }

    function b() {
        var o = Math.abs(parseInt($(".page-tabs-content").css("margin-left")));
        var l = f($(".content-tabs").children().not(".J_menuTabs"));
        var k = $(".content-tabs").outerWidth(true) - l;
        var p = 0;
        if ($(".page-tabs-content").width() < k) {
            return false
        } else {
            var m = $(".J_menuTab:first");
            var n = 0;
            while ((n + $(m).outerWidth(true)) <= o) {
                n += $(m).outerWidth(true);
                m = $(m).next()
            }
            n = 0;
            while ((n + $(m).outerWidth(true)) < (k) && m.length > 0) {
                n += $(m).outerWidth(true);
                m = $(m).next()
            }
            p = f($(m).prevAll());
            if (p > 0) {
                $(".page-tabs-content").animate({marginLeft: 0 - p + "px"}, "fast")
            }
        }
    }

    //$(".J_menuItem").each(function (k) {
    //    if (!$(this).attr("data-index")) {
    //        $(this).attr("data-index", k)
    //    }
    //});
    function openTab(event, refresh) {
        var href = $(this).attr("href"), id = href, m = $(this).data("index"), l = $.trim($(this).attr("title") || $(this).text()), k = true;
        if (href == undefined || $.trim(href).length == 0) {
            return false
        }
        if (id.indexOf('?') > -1) {
            id = id.substr(0, id.indexOf('?'));
        }
        addTab(id);

        var tab = getTab(id);
        var content = getCurrentTabContent();
        if (tab) {
            if (!$(tab).hasClass("active")) {
                $(tab).addClass("active").siblings(".J_menuTab").removeClass("active");
                g(tab);

                $(content).show().siblings(".J_iframe").hide();
                if (refresh == true) {
                    reloadTab(content, href);
                }
            } else {
                reloadTab(content, href);
            }
            return false;
        }

        var p = '<a href="javascript:;" class="active J_menuTab" data-id="' + id + '">' + l + ' <i class="fa fa-times-circle"></i></a>';
        $(".J_menuTab").removeClass("active");
        var n = $('<iframe class="J_iframe" width="100%" height="100%" src="' + href + '" frameborder="0" data-id="' + id + '" seamless></iframe>');
        $(".J_mainContent").find("iframe.J_iframe").hide().parents(".J_mainContent").append(n);
        $(".J_menuTabs .page-tabs-content").append(p);
        g($(".J_menuTab.active"));
        return false;
    }

    $(".J_menuItem").on("click", openTab);
    function closeTab() {
        debugger
        var m = $(this).parents(".J_menuTab").data("id");
        var l = $(this).parents(".J_menuTab").width();

        removeTab(m);
        $(this).parents(".J_menuTab").remove();
        $(".J_mainContent .J_iframe").each(function () {
            if ($(this).data("id") == m) {
                $(this).remove();
                return false
            }
        });

        if (!$(".J_menuTab.active").length) {
            var tab = getCurrentTab();
            var content = getCurrentTabContent();

            $(tab).addClass('active');
            $(content).show();
        }
        g($(".J_menuTab.active"))

        return false
    }

    $(".J_menuTabs").on("click", ".J_menuTab i", closeTab);
    $(".J_tabCloseOther").on("click", function () {
        $(".page-tabs-content").children("[data-id]").not(":first").not(".active").each(function () {
            $('.J_iframe[data-id="' + $(this).data("id") + '"]').remove();
            $(this).remove()
        });
        $(".page-tabs-content").css("margin-left", "0")
    });
    $(".J_tabShowActive").on("click", function () {
        g($(".J_menuTab.active"))
    });
    $(".J_menuTabs").on("click", ".J_menuTab", function () {
        if (!$(this).hasClass("active")) {
            var k = $(this).data("id");
            addTab(k);
            $(".J_mainContent .J_iframe").each(function () {
                if ($(this).data("id") == k) {
                    $(this).show().siblings(".J_iframe").hide();
                    return false
                }
            });
            $(this).addClass("active").siblings(".J_menuTab").removeClass("active");
            g(this)
        }
    });
    $(".J_menuTabs").on("dblclick", ".J_menuTab", function () {
        var l = $('.J_iframe[data-id="' + $(this).data("id") + '"]');
        l.attr("src", l.attr('src'));
    });
    $(".J_tabLeft").on("click", a);
    $(".J_tabRight").on("click", b);
    $(".J_tabCloseAll").on("click", function () {
        $(".page-tabs-content").children("[data-id]").not(":first").each(function () {
            $('.J_iframe[data-id="' + $(this).data("id") + '"]').remove();
            $(this).remove()
        });
        $(".page-tabs-content").children("[data-id]:first").each(function () {
            $('.J_iframe[data-id="' + $(this).data("id") + '"]').show();
            $(this).addClass("active")
        });
        $(".page-tabs-content").css("margin-left", "0")
    })
});
